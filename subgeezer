#!/bin/bash

usage="Usage: subgeezer [options] svn_root_url git_repository_path"
help="subgeezer SVN to Git converter (v1.0.0)

${usage}

Options:
  -h, --help    Display help
  -n            Prompt for Git User <email> to convert SVN usernames in log

Example: subgeezer -n http://swfobject.googlecode.com/svn ~/swfObject.git"

err[1]="Invalid command"
err[2]="SVN client is required"
err[3]="Git client is required"
err[4]="svn2git is required, see https://github.com/nirvdrum/svn2git"

# Check for SVN client
if [ -z `which svn` ]
then
  echo "${err[2]}, exiting..."
  exit 2
fi

# Check for Git client
if [ -z `which git` ]
then
  echo "${err[3]}, exiting..."
  exit 3
fi

# Check for svn2git
if [ -z `which svn2git` ]
then
  echo "${err[4]}, exiting..."
  exit 4
fi

# Check for command formatting exceptions
if [[ -z "$@" ]]
then
  echo "${err[1]}"
  echo "${usage}"
  exit 1
elif [[ "$1" == "--help" || "$1" == "-h" ]]
then
  echo "${help}"
  exit 0
elif [[ "$#" < 2 ]]
then
  echo "${err[1]}"
  echo "${usage}"
  exit 1
fi

# Parse command arguments
if [ "$1" == "-n" ]
then
  prompt_author=true
  svn_repo=$2
  git_repo=$3
else
  prompt_author=false
  svn_repo=$1
  git_repo=$2
fi

# Ensure temp folder exists
test -d ~/temp || mkdir -p ~/temp
cd ~/temp

# Fetch and convert credentials in the log
while read line; do
  authors=`awk -F '|' '/^r/ {sub("^ ", "", $2); sub(" $", "", $2); print $2";"}' | sort -u`
done < <(svn log -q $svn_repo)

if $prompt_author;
then
  echo "Starting credential conversion from 'username' to 'Forename Surname <email@address.com>'"
  echo "Entering empty values will cause a fallback to 'username <username>'"
else
  echo "No credential conversion, falling back to 'username <username>'"
fi

touch ~/temp/authors.txt
cat /dev/null > ~/temp/authors.txt

OIFS=$IFS
IFS=";"
for author in $authors
do
  trimmed_author=`echo -n $author | tr -d "\n"`
  if $prompt_author;
  then
    echo "Please define Git info for user $trimmed_author: "
    read -p "Forename: " forename
    read -p "Surname: " surname
    read -p "Email: " email
  fi
  echo "$trimmed_author = ${forename:-$trimmed_author} ${surname} <${email:-$trimmed_author}>" >> ~/temp/authors.txt
done

test -d $git_repo || mkdir -p $git_repo
cd $git_repo
svn2git $svn_repo --trunk trunk --verbose --authors ~/temp/authors.txt --no-minimize-url

echo "Conversion completed."
exit 0